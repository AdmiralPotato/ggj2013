<!DOCTYPE html>
<html>
<head>
<title>Global Game Jam 2013</title>
<style></style>
</head>
<body>
<script type = "text/javascript" src = "https://raw.github.com/mrdoob/three.js/master/build/three.js"></script>
<script type = "text/javascript" src="eyeguy.js"></script>
<script>
window.requestAnimFrame = (function(){
	return  window.requestAnimationFrame       || 
		window.webkitRequestAnimationFrame || 
		window.mozRequestAnimationFrame    || 
		window.oRequestAnimationFrame      || 
		window.msRequestAnimationFrame     || 
		function( callback ){
			window.setTimeout(callback, 1000 / 60);
		};
})();

	var width = window.innerWidth;
	var height = window.innerHeight;
	
	var scene = new THREE.Scene();
	var camera = new THREE.PerspectiveCamera(50, width/height, 0.1, 1000);
	camera.position.z = 5;
	var rend = new THREE.WebGLRenderer();
	rend.setSize(width, height);
	document.body.appendChild(rend.domElement);
	function render(){
		requestAnimFrame(render);
		if(window.innerWidth != width || window.innerHeight != height){
			width = window.innerWidth;
			height = window.innerHeight;
			camera.aspect = width/height;
			camera.updateProjectionMatrix()
			rend.setSize(width, height);
		}
		rend.render(scene, camera);
	}
	render();
	
	var geometryObjects = {};
	var imageLoadHandler = function(){
		 this.texture.needsUpdate = true;
		 console.log( this.src + ' it loaded!');
	};
	var parseAllGeometry = function(_jsonObjectSet, callback) {
		var propertyName, modelData, modelCount = 0, modelsLoaded = 0;
		for(propertyName in _jsonObjectSet){
			if(_jsonObjectSet.hasOwnProperty(propertyName)){
				modelCount += 1;
				modelData = _jsonObjectSet[propertyName];
				var materialData = modelData.materials[0];
				var img = new Image();
				var tex = new THREE.Texture(img);
				img.texture = tex;
				img.onload = imageLoadHandler;
				img.src = materialData.mapDiffuse;
				var mat = new THREE.MeshLambertMaterial({
					color: 0xffffff,
					map: tex
				});
				var meshCreationHandler = function(geometry, materials) {
					geometry.materials = materials;
					geometryObjects[propertyName] = geometry;
					modelsLoaded += 1;
					if(modelsLoaded === modelCount){
						callback();
					}
				};
				var jsonDataLoader = new THREE.JSONLoader();
				jsonDataLoader.createModel(modelData, meshCreationHandler, './');
			}
		}
	}
	var whatToDoWhenAllTheGeometriesAreParsedOkayYupSeriously = function(){
		var myMesh = new THREE.Mesh(geometryObjects.eyeguy, geometryObjects.eyeguy.material);
		scene.add(myMesh);
	};
	
	parseAllGeometry(
		{
			'eyeguy': eyeguy
		},
		whatToDoWhenAllTheGeometriesAreParsedOkayYupSeriously
	);

</script>
</body>
</html>